<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
/* ===================================
   WMO-Style Enhanced Dashboard CSS
   =================================== */

/* CSS Variables for consistent theming */
:root {
  --wmo-blue-primary: #00529C;
  --wmo-blue-secondary: #0066CC;
  --wmo-blue-light: #E6F2FF;
  --wmo-gray-dark: #2c3e50;
  --wmo-gray-medium: #495057;
  --wmo-gray-light: #e9ecef;
  --wmo-gray-lighter: #f8f9fa;
  --wmo-success: #28a745;
  --wmo-warning: #ffc107;
  --wmo-danger: #dc3545;
  --sidebar-width: 320px;
  --header-height: 60px;
  --spacing-xs: 8px;
  --spacing-sm: 12px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  --border-radius-sm: 8px;
  --border-radius-md: 12px;
  --border-radius-lg: 16px;
  --transition-speed: 0.3s;
}

/* ===================================
   Base Styles & Typography
   =================================== */

body, p, div, li {
  font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  font-size: 15px;
  line-height: 1.6;
  color: var(--wmo-gray-dark);
}

h1 {
  font-size: 2rem;
  font-weight: 600;
  color: var(--wmo-blue-primary);
  margin-bottom: var(--spacing-lg);
  line-height: 1.2;
}

h2 {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--wmo-blue-primary);
  margin-top: var(--spacing-xl);
  margin-bottom: var(--spacing-md);
  line-height: 1.3;
}

h3 {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--wmo-gray-dark);
  margin-top: var(--spacing-lg);
  margin-bottom: var(--spacing-sm);
  line-height: 1.3;
}

h4 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--wmo-gray-medium);
  margin-bottom: var(--spacing-sm);
}

/* Hide default page elements */
.tab-content {
  width: 100% !important;
  max-width: 100% !important;
  flex: 0 0 100% !important;
  margin-left: 0 !important;
  padding-left: 0 !important;
}

.page-title {
  display: none !important;
}

.breadcrumb {
  display: none !important;
}

/* ===================================
   Breadcrumb Navigation
   =================================== */

.breadcrumb-new {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin: 0;
  padding: var(--spacing-md) 0;
  list-style: none;
  border-bottom: 1px solid var(--wmo-gray-light);
  flex-wrap: wrap;
  font-size: 14px;
}

.breadcrumb-new a {
  color: var(--wmo-blue-primary);
  text-decoration: none;
  font-weight: 500;
  position: relative;
  padding-bottom: 4px;
  transition: all var(--transition-speed) ease;
}

.breadcrumb-new a::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 2px;
  background: var(--wmo-blue-primary);
  transition: width var(--transition-speed) ease;
}

.breadcrumb-new a:hover::after {
  width: 100%;
}

.breadcrumb-new .separator {
  color: #adb5bd;
  font-weight: 300;
}

.breadcrumb-new .current {
  color: var(--wmo-gray-medium);
  font-weight: 600;
}

/* ===================================
   Main Layout Structure
   =================================== */

.dashboard-header-top {
  background: white;
  padding: var(--spacing-xl) var(--spacing-xl);
  border-radius: var(--border-radius-lg);
  margin-bottom: var(--spacing-lg);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.dashboard-header-top h1 {
  margin-bottom: var(--spacing-sm);
}

.dashboard-header-top p {
  color: var(--wmo-gray-medium);
  font-size: 15px;
  margin: 0 0 var(--spacing-lg) 0;
}

.stats-panel-top {
  margin-top: var(--spacing-lg);
  padding-top: var(--spacing-lg);
  border-top: 2px solid var(--wmo-gray-light);
}

.dashboard-container {
  display: flex;
  min-height: 100vh;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

/* Left Sidebar */
.dashboard-sidebar {
  width: var(--sidebar-width);
  background: white;
  border-right: 2px solid var(--wmo-gray-light);
  position: relative;
  height: auto;
  min-height: 100vh;
  z-index: 100;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
}

.sidebar-header {
  padding: var(--spacing-lg);
  border-bottom: 2px solid var(--wmo-gray-light);
  background: linear-gradient(135deg, var(--wmo-blue-light), white);
}

.sidebar-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--wmo-blue-primary);
  margin: 0;
}

.sidebar-subtitle {
  font-size: 13px;
  color: var(--wmo-gray-medium);
  margin-top: 4px;
}

.sidebar-content {
  padding: var(--spacing-lg);
}

.sidebar-section {
  margin-bottom: var(--spacing-xl);
}

.sidebar-section-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--wmo-gray-medium);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--spacing-md);
  padding-bottom: var(--spacing-sm);
}

/* Collapsible Section */
.collapsible-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  user-select: none;
  padding-bottom: var(--spacing-sm);
  border-bottom: 2px solid var(--wmo-gray-light);
  margin-bottom: 0;
  transition: all var(--transition-speed) ease;
}

.collapsible-header:hover {
  opacity: 0.7;
}

.collapse-icon {
  font-size: 12px;
  color: var(--wmo-blue-primary);
  transition: transform var(--transition-speed) ease;
}

.collapse-icon.collapsed {
  transform: rotate(-90deg);
}

.collapsible-content {
  max-height: 500px;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.3s ease;
  opacity: 1;
}

.collapsible-content.collapsed {
  max-height: 0;
  opacity: 0;
}

/* Main Content Area */
.dashboard-main {
  flex: 1;
  padding: 0 var(--spacing-xl) var(--spacing-xl);
}

/* ===================================
   Active Filter Badge
   =================================== */

.active-filters-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(135deg, var(--wmo-blue-primary), var(--wmo-blue-secondary));
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-left: var(--spacing-sm);
  animation: pulse 2s ease-in-out infinite;
}

.active-filters-badge.hidden {
  display: none;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

/* ===================================
   Clear All Filters Button
   =================================== */

.clear-all-filters-btn {
  width: 100%;
  background: linear-gradient(135deg, var(--wmo-danger), #c82333);
  color: white;
  border: none;
  padding: 12px;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all var(--transition-speed) ease;
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
}

.clear-all-filters-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
}

.clear-all-filters-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* ===================================
   Filter Controls in Sidebar
   =================================== */

.filter-group {
  margin-bottom: var(--spacing-lg);
  position: relative;
}

.filter-group label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 600;
  color: var(--wmo-gray-dark);
  font-size: 14px;
  margin-bottom: var(--spacing-xs);
}

.filter-active-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--wmo-success);
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}

.filter-group select,
.filter-group input {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid var(--wmo-gray-light);
  border-radius: var(--border-radius-sm);
  font-size: 14px;
  transition: all var(--transition-speed) ease;
  font-family: 'Open Sans', sans-serif;
}

.filter-group select:focus,
.filter-group input:focus {
  outline: none;
  border-color: var(--wmo-blue-primary);
  box-shadow: 0 0 0 3px rgba(0, 82, 156, 0.1);
}

/* Active filter styling */
.filter-group select.active,
.filter-group input.active {
  border-color: var(--wmo-success);
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), white);
}

/* Clear button for search input */
.search-wrapper {
  position: relative;
}

.clear-search-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--wmo-gray-medium);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  transition: all var(--transition-speed) ease;
  opacity: 0;
  pointer-events: none;
}

.clear-search-btn.visible {
  opacity: 1;
  pointer-events: auto;
}

.clear-search-btn:hover {
  background: var(--wmo-danger);
  transform: translateY(-50%) scale(1.1);
}

.search-wrapper input {
  padding-right: 40px;
}

/* Source Indicator */
.source-indicator {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-top: var(--spacing-xs);
}

.source-indicator.kma { background: #CE1818; color: white; }
.source-indicator.cma { background: #187DCE; color: white; }
.source-indicator.jma { background: #3453AB; color: white; }
.source-indicator.jaxa { background: #78BBE6; color: white; }
.source-indicator.nasa { background: #2B3CC1; color: white; }
.source-indicator.noaa { background: #0693E3; color: white; }
.source-indicator.rosc { background: #E31E52; color: white; }
.source-indicator.eum { background: #2A2863; color: white; }
.source-indicator.imd { background: #1B640F; color: white; }
.source-indicator.isro { background: #F4840C; color: white; }
.source-indicator.swcem { background: #2A2863; color: white; }
.source-indicator.combined { background: var(--wmo-blue-primary); color: white; }

/* Refresh Button */
.refresh-btn {
  width: 100%;
  background: linear-gradient(135deg, var(--wmo-blue-primary), var(--wmo-blue-secondary));
  color: white;
  border: none;
  padding: 12px;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all var(--transition-speed) ease;
  margin-top: var(--spacing-sm);
}

.refresh-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 82, 156, 0.3);
}

.refresh-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* ===================================
   Hazard Filter Buttons
   =================================== */

.hazard-filters {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-sm);
}

.hazard-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: var(--spacing-md);
  background: var(--wmo-gray-lighter);
  border: 2px solid var(--wmo-gray-light);
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  transition: all var(--transition-speed) ease;
  text-align: center;
}

.hazard-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: var(--wmo-blue-primary);
}

.hazard-btn:focus {
  outline: 3px solid rgba(0, 82, 156, 0.3);
  outline-offset: 2px;
}

.hazard-btn.active {
  background: linear-gradient(135deg, var(--wmo-blue-primary), var(--wmo-blue-secondary));
  border-color: var(--wmo-blue-primary);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 82, 156, 0.3);
}

.hazard-icon {
  font-size: 1.75rem;
  line-height: 1;
}

.hazard-label {
  font-size: 13px;
  font-weight: 600;
  line-height: 1.2;
}

.clear-hazard-btn {
  grid-column: 1 / -1;
  background: var(--wmo-gray-medium);
  border: 2px solid var(--wmo-gray-medium);
  color: white;
  padding: 10px;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all var(--transition-speed) ease;
  margin-top: var(--spacing-xs);
}

.clear-hazard-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.clear-hazard-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* ===================================
   Statistics Panel
   =================================== */

.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-md);
}

.stat-item {
  text-align: center;
  padding: var(--spacing-lg);
  background: linear-gradient(135deg, var(--wmo-blue-light), white);
  border-radius: var(--border-radius-sm);
  border: 2px solid var(--wmo-gray-light);
}

.stat-number {
  font-size: 2rem;
  font-weight: 700;
  color: var(--wmo-blue-primary);
  line-height: 1;
}

.stat-label {
  font-size: 13px;
  color: var(--wmo-gray-medium);
  margin-top: 6px;
  font-weight: 500;
}

/* ===================================
   Quick Actions Bar
   =================================== */

.quick-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-md) var(--spacing-lg);
  background: white;
  border-radius: var(--border-radius-md);
  margin-bottom: var(--spacing-lg);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.bulk-actions {
  display: flex;
  gap: var(--spacing-sm);
  align-items: center;
}

.action-btn {
  background: linear-gradient(135deg, var(--wmo-blue-primary), var(--wmo-blue-secondary));
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  font-weight: 500;
  font-size: 14px;
  transition: all var(--transition-speed) ease;
  font-family: 'Open Sans', sans-serif;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 82, 156, 0.3);
}

.action-btn.secondary {
  background: linear-gradient(135deg, #6c757d, #5a6268);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.results-info {
  color: var(--wmo-gray-medium);
  font-size: 14px;
  font-weight: 500;
}

/* ===================================
   Product Cards Grid
   =================================== */

.products-grid {
  display: grid;
  gap: var(--spacing-lg);
  grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
}

.product-card {
  background: white;
  border-radius: var(--border-radius-md);
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all var(--transition-speed) ease;
  border: 2px solid transparent;
}

.product-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.product-card.expanded {
  border-color: var(--wmo-blue-primary);
  box-shadow: 0 8px 24px rgba(0, 82, 156, 0.15);
}

/* Product Card Header */
.product-card-header {
  padding: var(--spacing-lg);
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-md);
  background: linear-gradient(135deg, rgba(0, 82, 156, 0.02), rgba(255, 255, 255, 1));
  transition: all var(--transition-speed) ease;
}

.product-card-header:hover {
  background: linear-gradient(135deg, rgba(0, 82, 156, 0.08), rgba(255, 255, 255, 1));
}

.product-card.expanded .product-card-header {
  background: linear-gradient(135deg, var(--wmo-blue-light), white);
  border-bottom: 2px solid var(--wmo-gray-light);
}

.expand-icon {
  font-size: 1.25rem;
  color: var(--wmo-blue-primary);
  transition: transform var(--transition-speed) ease;
  flex-shrink: 0;
  margin-top: 2px;
  font-weight: bold;
}

.product-card.expanded .expand-icon {
  transform: rotate(90deg);
}

.product-header-content {
  flex: 1;
  min-width: 0;
}

.product-title {
  font-size: 1.15rem;
  font-weight: 600;
  color: var(--wmo-gray-dark);
  margin-bottom: var(--spacing-sm);
  line-height: 1.4;
}

.product-meta {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
  align-items: center;
}

/* Hazard Tags */
.hazard-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.hazard-tag {
  background: linear-gradient(135deg, var(--wmo-blue-primary), var(--wmo-blue-secondary));
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-transform: uppercase;
}

/* Operational Status */
.operational-status {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-transform: uppercase;
}

.operational-status.operational {
  background: #d4edda;
  color: #155724;
}

.operational-status.development {
  background: #fff3cd;
  color: #856404;
}

/* Product Card Body */
.product-card-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s ease;
}

.product-card.expanded .product-card-body {
  max-height: 3000px;
}

.product-card-body-inner {
  padding: var(--spacing-lg);
}

/* Provider Info */
.provider-info {
  margin-bottom: var(--spacing-lg);
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid var(--wmo-gray-light);
  font-size: 15px;
  color: var(--wmo-gray-medium);
}

.provider-info strong {
  color: var(--wmo-blue-primary);
}

/* Product Details Grid */
.product-details {
  display: grid;
  gap: var(--spacing-md);
}

.detail-row {
  display: grid;
  grid-template-columns: 160px 1fr;
  gap: var(--spacing-md);
  align-items: start;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--wmo-gray-lighter);
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  font-weight: 600;
  color: var(--wmo-gray-dark);
  font-size: 14px;
}

.detail-value {
  color: var(--wmo-gray-medium);
  font-size: 15px;
  word-break: break-word;
  line-height: 1.6;
}

/* ===================================
   Training Materials Section
   =================================== */

.training-materials {
  margin-top: var(--spacing-lg);
  padding: var(--spacing-lg);
  background: linear-gradient(135deg, #d4edda, #f8f9fa);
  border-radius: var(--border-radius-sm);
  border: 2px solid #c3e6cb;
}

.training-materials-title {
  font-size: 15px;
  font-weight: 600;
  color: #155724;
  margin-bottom: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.training-materials-title::before {
  content: "üìö";
  font-size: 1.25rem;
}

.training-links {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.training-link {
  display: inline-flex;
  align-items: center;
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  padding: 8px 16px;
  text-decoration: none;
  border-radius: var(--border-radius-sm);
  font-size: 13px;
  font-weight: 600;
  transition: all var(--transition-speed) ease;
}

.training-link:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  text-decoration: none;
  color: white;
}

.training-link::before {
  content: "üéì";
  margin-right: 6px;
}

/* ===================================
   Product Links
   =================================== */

.product-links {
  margin-top: var(--spacing-lg);
  padding-top: var(--spacing-md);
  border-top: 2px solid var(--wmo-gray-light);
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.product-link {
  display: inline-block;
  background: linear-gradient(135deg, var(--wmo-blue-primary), var(--wmo-blue-secondary));
  color: white;
  padding: 10px 18px;
  text-decoration: none;
  border-radius: var(--border-radius-sm);
  font-size: 14px;
  font-weight: 600;
  transition: all var(--transition-speed) ease;
}

.product-link:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 82, 156, 0.3);
  text-decoration: none;
  color: white;
}

/* ===================================
   Loading & Error States
   =================================== */

.loading, .no-results {
  text-align: center;
  padding: var(--spacing-xl) var(--spacing-lg);
  background: white;
  border-radius: var(--border-radius-md);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.loading {
  color: var(--wmo-gray-medium);
  font-size: 15px;
}

.error-message {
  background: #f8d7da;
  color: #721c24;
  padding: var(--spacing-md);
  border-radius: var(--border-radius-sm);
  margin: var(--spacing-md) 0;
  border: 2px solid #f5c6cb;
  font-size: 14px;
}

/* ===================================
   Loading Overlay
   =================================== */

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition-speed) ease;
}

.loading-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.loading-spinner {
  text-align: center;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid var(--wmo-gray-light);
  border-top: 4px solid var(--wmo-blue-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto var(--spacing-md);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===================================
   Mobile Responsive Design
   =================================== */

@media (max-width: 1024px) {
  :root {
    --sidebar-width: 280px;
  }
  
  .products-grid {
    grid-template-columns: 1fr;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .dashboard-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    overflow-y: auto;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform var(--transition-speed) ease;
  }
  
  .dashboard-sidebar.mobile-open {
    transform: translateX(0);
  }
  
  .dashboard-main {
    padding: var(--spacing-md);
  }
  
  .mobile-menu-toggle {
    display: block;
    position: fixed;
    top: var(--spacing-md);
    left: var(--spacing-md);
    z-index: 1001;
    background: var(--wmo-blue-primary);
    color: white;
    border: none;
    padding: var(--spacing-sm);
    border-radius: var(--border-radius-sm);
    cursor: pointer;
  }
  
  .hazard-filters {
    grid-template-columns: 1fr;
  }
  
  .stats-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  .detail-row {
    grid-template-columns: 1fr;
    gap: var(--spacing-xs);
  }
  
  .quick-actions {
    flex-direction: column;
    gap: var(--spacing-md);
    align-items: stretch;
  }
  
  .bulk-actions {
    flex-direction: column;
    width: 100%;
  }
  
  .action-btn {
    width: 100%;
  }
  
  .dashboard-header-top {
    padding: var(--spacing-md);
  }
}

/* Desktop - hide mobile menu toggle */
@media (min-width: 769px) {
  .mobile-menu-toggle {
    display: none;
  }
}
</style>

<!-- Breadcrumb Navigation -->
<div class="container">
  <ol class="breadcrumb-new">
    <li><a href="https://community.wmo.int/en">Home</a></li>
    <li><span class="separator">/</span></li>
    <li><a href="https://community.wmo.int/site/knowledge-hub/programmes-and-initiatives">Programmes and Initiatives</a></li>
    <li><span class="separator">/</span></li>
    <li><a href="https://community.wmo.int/en/activity-areas/wmo-space-programme-wsp">WMO Space Programme</a></li>
    <li><span class="separator">/</span></li>
    <li><a href="https://community.wmo.int/en/activity-areas/wmo-space-programme-wsp/wmo-regional-coordination-groups-satellite-data-requirements">Regional Activities</a></li>
    <li><span class="separator">/</span></li>
    <li>EW4All Satellite Products</li>
  </ol>
</div>

<!-- Dashboard Header (Above Everything) -->
<div class="container">
  <header class="dashboard-header-top">
    <h1>EW4All Satellite Products</h1>
    <p>Comprehensive satellite data products for early warning systems across priority hazards</p>
    
    <!-- Statistics Panel -->
    <div class="stats-panel-top">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number" id="totalProducts">0</div>
          <div class="stat-label">Total Products</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="visibleProducts">0</div>
          <div class="stat-label">Visible</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="uniqueProviders">0</div>
          <div class="stat-label">Providers</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="dataSources">0</div>
          <div class="stat-label">Sources</div>
        </div>
      </div>
    </div>
  </header>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p style="color: var(--wmo-blue-primary); font-weight: 600;">Loading data...</p>
  </div>
</div>

<!-- Mobile Menu Toggle (hidden on desktop) -->
<button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle filters menu">
  ‚ò∞ Filters
</button>

<!-- Main Dashboard Container -->
<div class="dashboard-container">
  
  <!-- Left Sidebar with Filters -->
  <aside class="dashboard-sidebar" id="dashboardSidebar">
    
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h2 class="sidebar-title">Filters & Settings</h2>
          <p class="sidebar-subtitle">Refine your product search</p>
        </div>
        <span class="active-filters-badge hidden" id="activeFiltersBadge">
          <span id="activeFiltersCount">0</span> active
        </span>
      </div>
    </div>
    
    <!-- Sidebar Content -->
    <div class="sidebar-content">      
      
      <!-- How to Use Section -->
      <div class="sidebar-section">
        <div class="collapsible-header" id="howToUseHeader">
          <span class="sidebar-section-title" style="margin: 0;">How to Use</span>
          <span class="collapse-icon" id="howToUseIcon">‚ñº</span>
        </div>
        <div class="collapsible-content" id="howToUseContent">
          <div style="font-size: 13px; line-height: 1.5; color: #495057; padding-top: 12px;">
            <p style="margin-bottom: 12px;">
              <strong style="color: #00529C;">Quick Start:</strong> Select a hazard below to filter products, or use the search box to find specific satellites or use cases.
            </p>
            <p style="margin-bottom: 12px;">
              <strong style="color: #00529C;">Data Sources:</strong> Switch between individual agencies (KMA, CMA, JMA, etc.) or view all combined data.
            </p>
            <p style="margin-bottom: 12px;">
              <strong style="color: #00529C;">Product Cards:</strong> Click any card to expand and see full details, including access links and training materials (üéì).
            </p>
            <p style="margin: 0;">
              <strong style="color: #00529C;">Tip:</strong> Use "Expand All" to compare multiple products at once.
            </p>
          </div>
        </div>
      </div>
      
      <!-- Clear All Filters Button -->
      <button class="clear-all-filters-btn" id="clearAllFiltersBtn" disabled>
        üóëÔ∏è Clear All Filters
      </button>
      
      <!-- Data Source Filter -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">Data Source</div>
        <div class="filter-group">
          <label for="dataSourceFilter">Select Source:</label>
          <select id="dataSourceFilter">
            <option value="combined">All Sources Combined</option>
            <option value="kma">KMA Dataset</option>
            <option value="cma">CMA Dataset</option>
            <option value="jma">JMA Dataset</option>
            <option value="jaxa">JAXA Dataset</option>
            <option value="nasa">NASA Dataset</option>
            <option value="noaa">NOAA Dataset</option>
            <option value="rosc">ROSC Dataset</option>
            <option value="eum">EUM Dataset</option>
            <option value="imd">IMD Dataset</option>
            <option value="isro">ISRO Dataset</option>
            <option value="swcem">SWCEM Dataset</option>
          </select>
          <span id="currentSourceIndicator" class="source-indicator combined">ALL SOURCES</span>
        </div>
        <div class="filter-group">
          <label for="providerFilter">
            Provider:
            <span class="filter-active-indicator" id="providerActiveIndicator" style="display: none;"></span>
          </label>
          <select id="providerFilter" aria-label="Filter by provider">
            <option value="">All Providers</option>
          </select>
        </div>
        <button id="refreshBtn" class="refresh-btn">üîÑ Refresh Data</button>
      </div>
      
      <!-- Hazard Filters -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">
          Priority Hazards
          <span class="filter-active-indicator" id="hazardActiveIndicator" style="display: none; margin-left: 8px;"></span>
        </div>
        <div class="hazard-filters">
          <button class="hazard-btn" data-hazard="flood" tabindex="0" aria-label="Filter by floods">
            <div class="hazard-icon">üåä</div>
            <div class="hazard-label">Floods</div>
          </button>
          
          <button class="hazard-btn" data-hazard="heat" tabindex="0" aria-label="Filter by heatwaves">
            <div class="hazard-icon">üî•</div>
            <div class="hazard-label">Heatwaves</div>
          </button>
          
          <button class="hazard-btn" data-hazard="tropical cyclone" tabindex="0" aria-label="Filter by tropical cyclones">
            <div class="hazard-icon">üåÄ</div>
            <div class="hazard-label">Tropical Cyclones</div>
          </button>
          
          <button class="hazard-btn" data-hazard="drought" tabindex="0" aria-label="Filter by droughts">
            <div class="hazard-icon">üèúÔ∏è</div>
            <div class="hazard-label">Droughts</div>
          </button>
          
          <button class="hazard-btn" data-hazard="fire" tabindex="0" aria-label="Filter by wildfires">
            <div class="hazard-icon">üî•</div>
            <div class="hazard-label">Wildfires</div>
          </button>
          
          <button class="hazard-btn" data-hazard="volcanic ash" tabindex="0" aria-label="Filter by volcanic ash">
            <div class="hazard-icon">üåã</div>
            <div class="hazard-label">Volcanic Ash</div>
          </button>
          
          <button class="clear-hazard-btn" id="clearHazardBtn" disabled>
            Clear Hazard Filter
          </button>
        </div>
      </div>
      
      <!-- Additional Filters -->
      <div class="sidebar-section">
        <div class="sidebar-section-title">Additional Filters</div>   
        
        <div class="filter-group">
          <label for="statusFilter">
            Operational Status:
            <span class="filter-active-indicator" id="statusActiveIndicator" style="display: none;"></span>
          </label>
          <select id="statusFilter" aria-label="Filter by operational status">
            <option value="">All Status</option>
            <option value="operational">Operational</option>
            <option value="development">In Development</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="accessFilter">
            Product Access:
            <span class="filter-active-indicator" id="accessActiveIndicator" style="display: none;"></span>
          </label>
          <select id="accessFilter" aria-label="Filter by product access">
            <option value="">All Products</option>
            <option value="with-links">With Access Links</option>
            <option value="with-training">With Training Materials</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="sortFilter">Sort By:</label>
          <select id="sortFilter" aria-label="Sort products">
            <option value="alpha-asc">A ‚Üí Z (Alphabetical)</option>
            <option value="alpha-desc">Z ‚Üí A (Reverse)</option>
          </select>
        </div>
        
      </div>
      
    </div>
  </aside>
  
  <!-- Main Content Area -->
  <main class="dashboard-main">
    
    <!-- Search Box - Moved here for better accessibility -->
    <div class="filter-group" style="margin-bottom: 20px;">
      <label for="searchBox">
        Search Keywords:
        <span class="filter-active-indicator" id="searchActiveIndicator" style="display: none;"></span>
      </label>
      <div class="search-wrapper">
        <input 
          type="text" 
          id="searchBox" 
          placeholder="Search products, sensors, use cases..."
          aria-label="Search satellite products"
        >
        <button class="clear-search-btn" id="clearSearchBtn" aria-label="Clear search">√ó</button>
      </div>
    </div>
    
    <!-- Quick Actions Bar -->
    <div class="quick-actions">
      <div class="bulk-actions">
        <button class="action-btn" id="expandAllBtn">
          ‚¨áÔ∏è Expand All
        </button>
        <button class="action-btn secondary" id="collapseAllBtn">
          ‚¨ÜÔ∏è Collapse All
        </button>
      </div>
      <div class="results-info">
        <span id="visibleProductsText">Showing 0 products</span>
      </div>
    </div>
    
    <!-- Products Container -->
    <div id="productsContainer">
      <div class="loading">
        <p>üõ∞Ô∏è Loading satellite products data...</p>
        <p style="font-size: 13px; margin-top: 8px; color: #6c757d;">Please wait while we fetch the latest information</p>
      </div>
    </div>
    
  </main>
  
</div>

<script>
// ===================================
// Global Variables
// ===================================
let allProducts = [];
let filteredProducts = [];
let loadedSources = new Set();
let searchDebounceTimer = null;

// Filter state
const filterState = {
  hazard: '',
  provider: '',
  status: '',
  access: '',
  search: '',
  sort: 'alpha-asc',
  dataSource: 'combined'
};

// Data sources configuration
const DATA_SOURCES = {
  kma: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=39503549&single=true&output=csv',
    name: 'Korea Meteorological Administration (KMA)',
    shortName: 'KMA'
  },
  cma: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=984604856&single=true&output=csv',
    name: 'China Meteorological Administration (CMA)',
    shortName: 'CMA'
  },
  jma: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=127608235&single=true&output=csv',
    name: 'Japan Meteorological Agency (JMA)',
    shortName: 'JMA'
  },
  jaxa: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=1514702731&single=true&output=csv',
    name: 'Japan Aerospace Exploration Agency (JAXA)',
    shortName: 'JAXA'
  },
  nasa: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=1985650139&single=true&output=csv',
    name: 'National Aeronautics and Space Administration (NASA)',
    shortName: 'NASA'
  },
  noaa: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=805786885&single=true&output=csv',
    name: 'National Oceanographic and Atmospheric Administration (NOAA)',
    shortName: 'NOAA'
  },
  rosc: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=127465695&single=true&output=csv',
    name: 'Roscosmoc (ROSC)',
    shortName: 'ROSC'
  },
  eum: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=672734367&single=true&output=csv',
    name: 'EUMETSAT (EUM)',
    shortName: 'EUM'
  },
  imd: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=331334327&single=true&output=csv',
    name: 'India Meteorological Department (IMD)',
    shortName: 'IMD'
  },
  isro: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=282561569&single=true&output=csv',
    name: 'Indian Space Research Organization (ISRO)',
    shortName: 'ISRO'
  },
  swcem: {
    url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_5Hb0zFmFs17gcRDQ-MNjRysKEWdXdVRKuC-iC10bj6u9X9DDsFOk6rubUBM7EBZ79G41Ai2W_lxE/pub?gid=1992686067&single=true&output=csv',
    name: 'Space-based Weather and Climate Extremes Monitoring (SWCEM)',
    shortName: 'SWCEM'
  }
};

// ===================================
// Utility Functions
// ===================================

function normalizeText(text) {
  if (!text || typeof text !== 'string') return '';
  return text.trim().toLowerCase().replace(/\s+/g, ' ');
}

function matchesProvider(productProvider, filterProvider) {
  if (!productProvider || !filterProvider) return false;
  
  const normalizedProduct = normalizeText(productProvider);
  const normalizedFilter = normalizeText(filterProvider);
  
  if (normalizedProduct === normalizedFilter) return true;
  
  if (normalizedFilter === 'noaa (nws, cpc)') {
    return normalizedProduct.includes('noaa') && 
           (normalizedProduct.includes('nws') || normalizedProduct.includes('cpc'));
  }
  
  const words = normalizedFilter.split(' ');
  const productWords = normalizedProduct.split(' ');
  const significantWords = words.filter(word => word.length > 2);
  
  return significantWords.every(word => 
    productWords.some(pWord => pWord.includes(word) || word.includes(pWord))
  );
}

function mapColumnHeaders(headers) {
  console.log('Available headers:', headers);
  
  const mapping = {};
  const patterns = {
    priorityHazards: /priority\s*hazard/i,
    inputData: /input\s*data|satellite|sensor/i,
    productName: /product\s*name|data\s*set|raw\s*data/i,
    useCase: /use\s*case|purpose|potential/i,
    frequency: /frequency|revisit|temporal\s*resolution/i,
    spatialResolution: /spatial\s*resolution/i,
    spatialExtent: /spatial\s*extent|geographical\s*coverage|coverage/i,
    temporalExtent: /temporal\s*extent|archived/i,
    deliveryLatency: /delivery\s*latency|real.*time|delayed/i,
    format: /format/i,
    dissemination: /dissemination|mechanism/i,
    urls: /url/i,
    dataPolicy: /data\s*policy|policy/i,
    operationalStatus: /operational|development|status/i,
    provider: /provider|organization/i,
    poc: /poc|contact/i,
    comments: /comment|remark/i,
    trainingMaterials: /training\s*materials?|training\s*resources?|learning\s*materials?|educational/i
  };
  
  for (const [key, pattern] of Object.entries(patterns)) {
    const matchedHeader = headers.find(header => pattern.test(header));
    if (matchedHeader) {
      mapping[key] = matchedHeader;
      console.log(`Mapped ${key} to: ${matchedHeader}`);
    }
  }
  
  return mapping;
}

// ===================================
// Loading Overlay Functions
// ===================================

function showLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.add('active');
  }
}

function hideLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.remove('active');
  }
}

// ===================================
// Mobile Sidebar Functions
// ===================================

function toggleMobileSidebar() {
  const sidebar = document.getElementById('dashboardSidebar');
  sidebar.classList.toggle('mobile-open');
}

function closeMobileSidebar() {
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('dashboardSidebar');
    sidebar.classList.remove('mobile-open');
  }
}

function toggleHowToUse() {
  const content = document.getElementById('howToUseContent');
  const icon = document.getElementById('howToUseIcon');
  
  content.classList.toggle('collapsed');
  icon.classList.toggle('collapsed');
}

// ===================================
// Filter State Management
// ===================================

function getActiveFilterCount() {
  let count = 0;
  if (filterState.hazard) count++;
  if (filterState.provider) count++;
  if (filterState.status) count++;
  if (filterState.access) count++;
  if (filterState.search) count++;
  if (filterState.dataSource !== 'combined') count++;
  return count;
}

function updateActiveFiltersBadge() {
  const badge = document.getElementById('activeFiltersBadge');
  const count = document.getElementById('activeFiltersCount');
  const clearAllBtn = document.getElementById('clearAllFiltersBtn');
  const clearHazardBtn = document.getElementById('clearHazardBtn');
  
  const activeCount = getActiveFilterCount();
  
  if (activeCount > 0) {
    badge.classList.remove('hidden');
    count.textContent = activeCount;
    clearAllBtn.disabled = false;
  } else {
    badge.classList.add('hidden');
    clearAllBtn.disabled = true;
  }
  
  // Update clear hazard button
  clearHazardBtn.disabled = !filterState.hazard;
}

function updateFilterIndicators() {
  // Data source indicator
  const dataSourceFilter = document.getElementById('dataSourceFilter');
  dataSourceFilter.classList.toggle('active', filterState.dataSource !== 'combined');
  
  // Provider indicator
  const providerIndicator = document.getElementById('providerActiveIndicator');
  providerIndicator.style.display = filterState.provider ? 'inline-block' : 'none';
  document.getElementById('providerFilter').classList.toggle('active', !!filterState.provider);
  
  // Status indicator
  const statusIndicator = document.getElementById('statusActiveIndicator');
  statusIndicator.style.display = filterState.status ? 'inline-block' : 'none';
  document.getElementById('statusFilter').classList.toggle('active', !!filterState.status);
  
  // Access indicator
  const accessIndicator = document.getElementById('accessActiveIndicator');
  accessIndicator.style.display = filterState.access ? 'inline-block' : 'none';
  document.getElementById('accessFilter').classList.toggle('active', !!filterState.access);
  
  // Search indicator
  const searchIndicator = document.getElementById('searchActiveIndicator');
  const clearSearchBtn = document.getElementById('clearSearchBtn');
  searchIndicator.style.display = filterState.search ? 'inline-block' : 'none';
  document.getElementById('searchBox').classList.toggle('active', !!filterState.search);
  clearSearchBtn.classList.toggle('visible', !!filterState.search);
  
  // Hazard indicator
  const hazardIndicator = document.getElementById('hazardActiveIndicator');
  hazardIndicator.style.display = filterState.hazard ? 'inline-block' : 'none';
}

function clearAllFilters() {
  // Reset filter state (except data source which requires reload)
  filterState.hazard = '';
  filterState.provider = '';
  filterState.status = '';
  filterState.access = '';
  filterState.search = '';
  // Keep sort and dataSource as is
  
  // Reset UI elements
  document.getElementById('searchBox').value = '';
  document.getElementById('providerFilter').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('accessFilter').value = '';
  
  // Reset data source to combined and reload
  if (filterState.dataSource !== 'combined') {
    filterState.dataSource = 'combined';
    document.getElementById('dataSourceFilter').value = 'combined';
    loadSatelliteProducts();
  } else {
    // Clear hazard selection
    document.querySelectorAll('.hazard-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Update indicators and apply filters
    updateActiveFiltersBadge();
    updateFilterIndicators();
    applyFilters();
  }
  
  // Close mobile sidebar
  closeMobileSidebar();
}

// ===================================
// Loading and Display Functions
// ===================================

function showLoading() {
  document.getElementById('productsContainer').innerHTML = `
    <div class="loading">
      <p>üõ∞Ô∏è Loading satellite products data...</p>
      <p style="font-size: 13px; margin-top: 8px; color: #6c757d;">Please wait while we fetch the latest information</p>
    </div>
  `;
}

function showError(message) {
  document.getElementById('productsContainer').innerHTML = `
    <div class="no-results">
      <h3>Error loading data</h3>
      <div class="error-message">${message}</div>
      <p>Please check your connection and try refreshing the data.</p>
    </div>
  `;
}

// ===================================
// Data Loading Functions
// ===================================

async function loadSingleSource(sourceKey) {
  const source = DATA_SOURCES[sourceKey];
  if (!source) {
    throw new Error(`Unknown data source: ${sourceKey}`);
  }

  try {
    const response = await fetch(source.url);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const csvText = await response.text();

    return new Promise((resolve, reject) => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        transformHeader: function(header) {
          return header.trim();
        },
        complete: function(results) {
          if (results.errors.length > 0) {
            console.warn(`Parsing warnings for ${sourceKey}:`, results.errors);
          }

          const columnMap = mapColumnHeaders(results.meta.fields);
          
          const validProducts = results.data.filter(row => {
            const productName = row[columnMap.productName] || '';
            return productName.trim() !== '';
          });

          validProducts.forEach(product => {
            product._dataSource = sourceKey;
            product._sourceName = source.name;
            product._sourceShortName = source.shortName;
            product._columnMap = columnMap;
          });

          console.log(`Loaded ${validProducts.length} products from ${sourceKey}`);
          resolve(validProducts);
        },
        error: function(error) {
          reject(new Error(`CSV parsing failed for ${sourceKey}: ${error.message}`));
        }
      });
    });
  } catch (error) {
    throw new Error(`Failed to load ${source.name}: ${error.message}`);
  }
}

async function loadSatelliteProducts() {
  const selectedSource = document.getElementById('dataSourceFilter').value;
  const refreshBtn = document.getElementById('refreshBtn');

  showLoading();
  showLoadingOverlay();
  refreshBtn.disabled = true;
  refreshBtn.textContent = '‚è≥ Loading...';

  try {
    allProducts = [];
    loadedSources.clear();

    if (selectedSource === 'combined') {
      // Load all sources
      const promises = Object.keys(DATA_SOURCES).map(async sourceKey => {
        try {
          const products = await loadSingleSource(sourceKey);
          loadedSources.add(sourceKey);
          return products;
        } catch (error) {
          console.error(`Error loading ${sourceKey}:`, error);
          return []; // Return empty array for failed sources
        }
      });

      const results = await Promise.all(promises);
      allProducts = results.flat();

      if (allProducts.length === 0) {
        throw new Error('No data could be loaded from any source');
      }
    } else {
      // Load single source
      allProducts = await loadSingleSource(selectedSource);
      loadedSources.add(selectedSource);
    }

    // Update filter state
    filterState.dataSource = selectedSource;

    updateSourceIndicator(selectedSource);
    clearFilterOptions();
    initializeFilters();
    filteredProducts = [...allProducts];
    
    // Apply current filters and sorting after loading
    applyFilters();
    
    updateStats();
    updateActiveFiltersBadge();
    updateFilterIndicators();

  } catch (error) {
    console.error('Error loading satellite products:', error);
    showError(error.message);
  } finally {
    hideLoadingOverlay();
    refreshBtn.disabled = false;
    refreshBtn.textContent = 'üîÑ Refresh Data';
  }
}

function updateSourceIndicator(selectedSource) {
  const indicator = document.getElementById('currentSourceIndicator');
  indicator.className = `source-indicator ${selectedSource}`;

  if (selectedSource === 'combined') {
    indicator.textContent = `ALL SOURCES (${loadedSources.size}/${Object.keys(DATA_SOURCES).length})`;
  } else {
    indicator.textContent = DATA_SOURCES[selectedSource].shortName;
  }
}

function clearFilterOptions() {
  const providerFilter = document.getElementById('providerFilter');
  providerFilter.innerHTML = '<option value="">All Providers</option>';
}

function initializeFilters() {
  const providers = new Set();
  allProducts.forEach(product => {
    const columnMap = product._columnMap;
    const provider = product[columnMap.provider];
    if (provider && provider.trim()) {
      providers.add(provider.trim());
    }
  });

  const providerFilter = document.getElementById('providerFilter');
  Array.from(providers).sort().forEach(provider => {
    const option = document.createElement('option');
    option.value = provider;
    option.textContent = provider;
    providerFilter.appendChild(option);
  });

  console.log('Available providers:', Array.from(providers));
}

// ===================================
// Filter Functions
// ===================================

function selectHazard(button, hazard) {
  // Toggle hazard selection
  if (button.classList.contains('active')) {
    button.classList.remove('active');
    filterState.hazard = '';
  } else {
    document.querySelectorAll('.hazard-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    button.classList.add('active');
    filterState.hazard = hazard;
  }
  
  updateActiveFiltersBadge();
  updateFilterIndicators();
  applyFilters();
  closeMobileSidebar();
}

function clearHazardFilter() {
  document.querySelectorAll('.hazard-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  filterState.hazard = '';
  updateActiveFiltersBadge();
  updateFilterIndicators();
  applyFilters();
}

function clearSearch() {
  document.getElementById('searchBox').value = '';
  filterState.search = '';
  updateActiveFiltersBadge();
  updateFilterIndicators();
  applyFilters();
}

function applyFilters() {
  console.log('Applying filters:', filterState);

  filteredProducts = allProducts.filter(product => {
    const columnMap = product._columnMap;
    
    // Hazard filter
    if (filterState.hazard) {
      const hazards = product[columnMap.priorityHazards] || '';
      if (!hazards.toLowerCase().includes(filterState.hazard.toLowerCase())) {
        return false;
      }
    }

    // Provider filter
    if (filterState.provider) {
      const productProvider = product[columnMap.provider];
      if (!matchesProvider(productProvider, filterState.provider)) {
        return false;
      }
    }

    // Status filter
    if (filterState.status) {
      const status = product[columnMap.operationalStatus]?.toLowerCase() || '';
      if (filterState.status === 'operational' && !status.includes('operational')) {
        return false;
      }
      if (filterState.status === 'development' && !status.includes('development')) {
        return false;
      }
    }

    // Access filter
    if (filterState.access) {
      const urls = product[columnMap.urls] || '';
      const training = product[columnMap.trainingMaterials] || '';
      
      if (filterState.access === 'with-links' && !urls.trim()) {
        return false;
      }
      if (filterState.access === 'with-training' && !training.trim()) {
        return false;
      }
    }

    // Search filter
    if (filterState.search) {
      const searchableText = [
        product[columnMap.productName],
        product[columnMap.inputData],
        product[columnMap.useCase],
        product[columnMap.provider],
        product[columnMap.priorityHazards],
        product._sourceName
      ].join(' ').toLowerCase();

      if (!searchableText.includes(filterState.search)) {
        return false;
      }
    }

    return true;
  });

  // Always apply sorting (not just conditionally)
  filteredProducts.sort((a, b) => {
    const nameA = (a[a._columnMap.productName] || '').toLowerCase();
    const nameB = (b[b._columnMap.productName] || '').toLowerCase();
    
    if (filterState.sort === 'alpha-desc') {
      return nameB.localeCompare(nameA);
    } else {
      // Default to alpha-asc
      return nameA.localeCompare(nameB);
    }
  });

  console.log(`Filtered ${filteredProducts.length} products from ${allProducts.length} total`);
  displayProducts();
  updateStats();
}

// ===================================
// Display Functions
// ===================================

function displayProducts() {
  const container = document.getElementById('productsContainer');

  if (filteredProducts.length === 0) {
    container.innerHTML = `
      <div class="no-results">
        <h3>No products found</h3>
        <p>Try adjusting your filters or search terms.</p>
        <button class="action-btn" onclick="clearAllFilters()" style="margin-top: 16px;">
          Clear All Filters
        </button>
      </div>
    `;
    return;
  }

  const productsGrid = document.createElement('div');
  productsGrid.className = 'products-grid';

  filteredProducts.forEach(product => {
    const card = createProductCard(product);
    productsGrid.appendChild(card);
  });

  container.innerHTML = '';
  container.appendChild(productsGrid);
}

function createProductCard(product) {
  const card = document.createElement('div');
  const columnMap = product._columnMap;
  
  card.className = 'product-card';

  const hazardTags = product[columnMap.priorityHazards] ? 
    product[columnMap.priorityHazards].split(',').map(h => h.trim()).filter(h => h) : [];

  const operationalStatus = product[columnMap.operationalStatus]?.toLowerCase() || '';
  const isOperational = operationalStatus.includes('operational');
  const isDevelopment = operationalStatus.includes('development');

  card.innerHTML = `
    <div class="product-card-header">
      <div class="expand-icon">‚ñ∂</div>
      <div class="product-header-content">
        <div class="product-title">
          ${product[columnMap.productName] || 'Unnamed Product'}
        </div>
        <div class="product-meta">
          <div class="hazard-tags">
            ${hazardTags.slice(0, 3).map(tag => `<span class="hazard-tag">${tag}</span>`).join('')}
            ${hazardTags.length > 3 ? `<span class="hazard-tag">+${hazardTags.length - 3} more</span>` : ''}
          </div>
          ${product._sourceShortName ? `<span class="source-indicator ${product._dataSource}">${product._sourceShortName}</span>` : ''}
          ${isOperational ? '<span class="operational-status operational">Operational</span>' : ''}
          ${isDevelopment ? '<span class="operational-status development">In Development</span>' : ''}
        </div>
      </div>
    </div>
    
    <div class="product-card-body">
      <div class="product-card-body-inner">
        <div class="provider-info">
          <strong>Provider:</strong> ${product[columnMap.provider] || 'Unknown Provider'}
        </div>
        
        ${hazardTags.length > 3 ? `
          <div class="detail-row">
            <div class="detail-label">All Hazards:</div>
            <div class="detail-value">
              <div class="hazard-tags">
                ${hazardTags.map(tag => `<span class="hazard-tag">${tag}</span>`).join('')}
              </div>
            </div>
          </div>
        ` : ''}
        
        <div class="product-details">
          ${createDetailRow('Satellite/Sensor', product[columnMap.inputData])}
          ${createDetailRow('Use Cases', product[columnMap.useCase])}
          ${createDetailRow('Frequency/Revisit', product[columnMap.frequency])}
          ${createDetailRow('Spatial Resolution', product[columnMap.spatialResolution])}
          ${createDetailRow('Coverage', product[columnMap.spatialExtent])}
          ${createDetailRow('Temporal Extent', product[columnMap.temporalExtent])}
          ${createDetailRow('Delivery Latency', product[columnMap.deliveryLatency])}
          ${createDetailRow('Format', product[columnMap.format])}
          ${createDetailRow('Dissemination', product[columnMap.dissemination])}
          ${createDetailRow('Data Policy', product[columnMap.dataPolicy])}
          ${product[columnMap.poc] ? createDetailRow('Point of Contact', product[columnMap.poc]) : ''}
          ${product[columnMap.comments] ? createDetailRow('Comments', product[columnMap.comments]) : ''}
        </div>

        ${createProductLinks(product[columnMap.urls])}
        ${createTrainingMaterials(product[columnMap.trainingMaterials])}
      </div>
    </div>
  `;

  const header = card.querySelector('.product-card-header');
  header.addEventListener('click', function() {
    card.classList.toggle('expanded');
  });

  return card;
}

function createDetailRow(label, value) {
  if (!value || value.toString().trim() === '') return '';
  return `
    <div class="detail-row">
      <div class="detail-label">${label}:</div>
      <div class="detail-value">${value}</div>
    </div>
  `;
}

function createProductLinks(urls) {
  if (!urls || urls.toString().trim() === '') return '';

  const urlList = urls.split(/[,;\n\r]+/).map(url => url.trim()).filter(url => url);
  if (urlList.length === 0) return '';

  const linksHtml = urlList.map((url, index) => {
    let cleanUrl = url;
    if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
      cleanUrl = 'https://' + url;
    }

    const linkText = urlList.length === 1 ? 'üîó Access Product' : `üîó Access Link ${index + 1}`;
    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="product-link">${linkText}</a>`;
  }).join('');

  return `<div class="product-links">${linksHtml}</div>`;
}

function createTrainingMaterials(trainingMaterials) {
  if (!trainingMaterials || trainingMaterials.toString().trim() === '') return '';

  const trainingList = trainingMaterials.split(/[,;\n\r]+/).map(url => url.trim()).filter(url => url);
  if (trainingList.length === 0) return '';

  const trainingLinksHtml = trainingList.map((url, index) => {
    let cleanUrl = url;
    if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
      cleanUrl = 'https://' + url;
    }

    let linkText = 'Training Material';
    if (trainingList.length > 1) {
      linkText = `Training ${index + 1}`;
    }

    if (url.toLowerCase().includes('tutorial')) {
      linkText = trainingList.length === 1 ? 'Tutorial' : `Tutorial ${index + 1}`;
    } else if (url.toLowerCase().includes('guide')) {
      linkText = trainingList.length === 1 ? 'User Guide' : `Guide ${index + 1}`;
    } else if (url.toLowerCase().includes('manual')) {
      linkText = trainingList.length === 1 ? 'Manual' : `Manual ${index + 1}`;
    } else if (url.toLowerCase().includes('documentation')) {
      linkText = trainingList.length === 1 ? 'Documentation' : `Documentation ${index + 1}`;
    }

    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="training-link">${linkText}</a>`;
  }).join('');

  return `
    <div class="training-materials">
      <div class="training-materials-title">Training Materials</div>
      <div class="training-links">${trainingLinksHtml}</div>
    </div>
  `;
}

function updateStats() {
  document.getElementById('totalProducts').textContent = allProducts.length;
  document.getElementById('visibleProducts').textContent = filteredProducts.length;
  document.getElementById('dataSources').textContent = loadedSources.size;

  const uniqueProviders = new Set();
  allProducts.forEach(product => {
    const columnMap = product._columnMap;
    const provider = product[columnMap.provider];
    if (provider && provider.trim()) {
      uniqueProviders.add(provider.trim());
    }
  });
  document.getElementById('uniqueProviders').textContent = uniqueProviders.size;

  const visibleText = document.getElementById('visibleProductsText');
  if (visibleText) {
    visibleText.textContent = `Showing ${filteredProducts.length} of ${allProducts.length} products`;
  }
}

// ===================================
// Bulk Actions
// ===================================

function expandAll() {
  document.querySelectorAll('.product-card').forEach(card => {
    card.classList.add('expanded');
  });
}

function collapseAll() {
  document.querySelectorAll('.product-card').forEach(card => {
    card.classList.remove('expanded');
  });
}

// ===================================
// Event Listeners & Initialization
// ===================================

document.addEventListener('DOMContentLoaded', function() {
  // Data source change
  document.getElementById('dataSourceFilter').addEventListener('change', loadSatelliteProducts);
  
  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', loadSatelliteProducts);
  
  // Filter changes
  document.getElementById('providerFilter').addEventListener('change', function(e) {
    filterState.provider = e.target.value;
    updateActiveFiltersBadge();
    updateFilterIndicators();
    applyFilters();
  });
  
  document.getElementById('statusFilter').addEventListener('change', function(e) {
    filterState.status = e.target.value;
    updateActiveFiltersBadge();
    updateFilterIndicators();
    applyFilters();
  });
  
  document.getElementById('accessFilter').addEventListener('change', function(e) {
    filterState.access = e.target.value;
    updateActiveFiltersBadge();
    updateFilterIndicators();
    applyFilters();
  });
  
  document.getElementById('sortFilter').addEventListener('change', function(e) {
    filterState.sort = e.target.value;
    applyFilters();
  });
  
  // Search with debouncing
  document.getElementById('searchBox').addEventListener('input', function(e) {
    const value = e.target.value.toLowerCase();
    
    // Clear existing timer
    if (searchDebounceTimer) {
      clearTimeout(searchDebounceTimer);
    }
    
    // Set new timer
    searchDebounceTimer = setTimeout(() => {
      filterState.search = value;
      updateActiveFiltersBadge();
      updateFilterIndicators();
      applyFilters();
    }, 300); // 300ms debounce delay
  });
  
  // Clear search button
  document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
  
  // Clear all filters button
  document.getElementById('clearAllFiltersBtn').addEventListener('click', clearAllFilters);
  
  // Clear hazard filter button
  document.getElementById('clearHazardBtn').addEventListener('click', clearHazardFilter);
  
  // Bulk actions
  document.getElementById('expandAllBtn').addEventListener('click', expandAll);
  document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
  
  // How to use toggle
  document.getElementById('howToUseHeader').addEventListener('click', toggleHowToUse);
  
  // Mobile menu toggle
  document.getElementById('mobileMenuToggle').addEventListener('click', toggleMobileSidebar);
  
  // Hazard buttons with keyboard support
  document.querySelectorAll('.hazard-btn').forEach(btn => {
    const hazard = btn.getAttribute('data-hazard');
    
    btn.addEventListener('click', function() {
      selectHazard(btn, hazard);
    });
    
    btn.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectHazard(btn, hazard);
      }
    });
  });
  
  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', function(event) {
    if (window.innerWidth <= 768) {
      const sidebar = document.getElementById('dashboardSidebar');
      const toggle = document.getElementById('mobileMenuToggle');
      
      if (sidebar && toggle && 
          !sidebar.contains(event.target) && 
          !toggle.contains(event.target)) {
        sidebar.classList.remove('mobile-open');
      }
    }
  });
  
  // Load initial data
  loadSatelliteProducts();
});
</script>
